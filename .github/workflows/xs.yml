name: xs

on:
  push:
    branches: [main]
    paths:
      - 'xs.yml'
      - 'xs.py'
  pull_request:
    branches: [main]
    paths:
      - 'xs.yml'
      - 'xs.py'
  schedule:
    - cron: '2 */3 * * *'
  watch:
    types: started
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: åˆå§‹åŒ–Pythonç¯å¢ƒ
        uses: actions/setup-python@v3
        with:
          python-version: 3.9
          
      - name: å®‰è£…ä¾èµ–
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            echo "âš ï¸ requirements.txtä¸å­˜åœ¨ï¼Œè·³è¿‡ä¾èµ–å®‰è£…"
          fi
          
      - name: å‡†å¤‡dailiå·¥ä½œç›®å½•
        run: |
          echo "ğŸ“ æ£€æŸ¥dailiç›®å½•çŠ¶æ€..."
          
          # æ£€æŸ¥dailiæ˜¯å¦å­˜åœ¨
          if [ -e "daili" ]; then
            if [ -f "daili" ]; then
              echo "ğŸ”„ dailiæ˜¯æ–‡ä»¶ï¼Œåˆ é™¤å¹¶åˆ›å»ºä¸ºç›®å½•"
              rm -f daili
              mkdir -p daili
            elif [ -d "daili" ]; then
              echo "âœ… dailiç›®å½•å·²å­˜åœ¨"
              # ç¡®ä¿ç›®å½•å¯å†™
              chmod 755 daili
            else
              echo "â“ dailiæ˜¯ç‰¹æ®Šæ–‡ä»¶ç±»å‹ï¼Œåˆ é™¤åé‡å»º"
              rm -rf daili
              mkdir -p daili
            fi
          else
            echo "ğŸ“ åˆ›å»ºdailiç›®å½•"
            mkdir -p daili
          fi
          
          echo "âœ… ç›®å½•å‡†å¤‡å®Œæˆ"
          ls -la | grep daili
          
      - name: è¿è¡Œä¸»è„šæœ¬
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_USER_ID: ${{ secrets.TG_USER_ID }}
        run: |
          echo "ğŸ”§ ç¯å¢ƒæ£€æŸ¥:"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "Pythonç‰ˆæœ¬: $(python3 --version)"
          echo "æ–‡ä»¶åˆ—è¡¨:"
          ls -la
          
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œxs.py..."
          if [ -f "xs.py" ]; then
            python3 xs.py
            echo "âœ… è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ xs.pyæ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi

      - name: æäº¤æ›´æ”¹
        run: |
          echo "ğŸ’¾ å‡†å¤‡æäº¤æ›´æ”¹..."
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          git status
          
          if git diff-index --quiet HEAD --; then
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
          else
            echo "ğŸ“ æ£€æµ‹åˆ°æ›´æ”¹ï¼Œæ­£åœ¨æäº¤..."
            git add -A
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–° - $(date +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ… æ›´æ”¹å·²æäº¤åˆ°ä»“åº“"
          fi
